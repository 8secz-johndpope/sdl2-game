#define FRAMERATE 60

#include <iostream>
#include <SDL2/SDL.h>
#include <SDL2/SDL_image.h>

#include "renderWindow.hpp"
#include "entity.hpp"
#include "camera.hpp"
#include "map.hpp"
#include "character.hpp"
#include "controller.hpp"
#include "mapEvent.hpp"
#include "eventList.hpp"
#include "dynamicEntity.hpp"
#include "item.hpp"

int main(int argc, char* args[]) {
    if (SDL_Init(SDL_INIT_VIDEO) > 0)
        std::cout << "SDL2 Initialization Failed: " << SDL_GetError() << std::endl;
    if (!(IMG_Init(IMG_INIT_PNG)))
        std::cout << "SDL2_Image Initialization Failed: " << SDL_GetError() << std::endl;

    RenderWindow window("sdl2-game", 1280, 720);

    SDL_Texture* general = window.loadTexture("assets/images/general.png");
    SDL_Texture* character = window.loadTexture("assets/images/character.png");
    SDL_Texture* miscText = window.loadTexture("assets/images/misc.png");
    SDL_Texture* skyText = window.loadTexture("assets/images/sky.png");

    int reference[MAP_HEIGHT][MAP_WIDTH] = {{'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','i','j','j','j','k','0','0','0','0','l','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','i','j','j','j','k','0','0','0','0','l','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','i','j','j','j','k','0','0','0','0','l','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','i','j','j','j','k','0','0','0','0','l','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','i','j','k','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','m','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','l','m','n','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','2','2','2','2','2','2','2','2','0','0','0','2','2','2','3','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','0','0','0','0','0','0','0','0','2','2','2','0','0','0','0','2','3','3','2','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','4','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','4','4','0','0','0','0','0','0','0'},
                                            {'0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','3','0','0','0','2','3','2','3','2','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','8','9','0','0','0','0','0','0','0','0','0','8','9','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','2','3','2','0','0','0','0','0','0','0','0','0','0','0','0','0','0','2','0','0','0','0','0','2','2','0','0','0','0','3','0','0','3','0','0','3','0','0','0','0','0','2','0','0','0','0','0','0','0','0','0','0','2','2','0','0','0','0','0','0','4','0','0','4','0','0','0','0','0','0','0','0','0','0','4','4','0','0','4','0','0','0','0','0','0','0','0','0','0','0','0','2','2','3','2','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','4','4','4','0','0','0','0','0','0','0'},
                                            {'0','0','g','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','8','9','0','0','0','0','0','0','6','7','0','0','g','0','0','0','0','0','0','6','7','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','g','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','0','0','4','4','0','0','0','0','g','0','0','0','4','4','4','0','0','4','4','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','4','4','4','4','0','0','0','0','g','0','0'},
                                            {'0','d','h','f','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','g','0','0','0','0','0','0','0','0','0','0','8','9','0','0','0','0','0','0','0','0','6','7','0','0','0','0','0','0','6','7','0','d','h','f','0','0','0','0','0','6','7','0','0','0','0','0','0','g','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','d','h','f','0','0','0','0','0','0','0','0','0','0','0','0','0','g','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','0','0','4','4','4','0','0','d','h','f','0','4','4','4','4','0','0','4','4','4','0','0','0','g','0','8','9','0','0','0','0','0','0','0','0','0','0','0','0','0','0','8','9','0','4','4','4','4','4','4','4','4','0','0','0','d','h','f','0'},
                                            {'d','h','e','h','f','0','0','0','0','0','0','0','0','a','b','b','b','c','d','h','f','0','0','0','0','a','b','c','0','0','6','7','0','0','0','0','0','0','0','0','6','7','0','a','b','b','c','0','6','7','d','h','e','h','f','0','0','0','0','6','7','a','b','b','b','c','d','h','f','0','0','0','0','a','b','c','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','a','b','b','c','0','0','0','d','h','e','h','f','0','0','0','0','0','0','a','b','b','b','c','d','h','f','0','0','0','0','a','b','c','0','0','0','0','0','0','0','0','0','0','0','0','4','4','4','4','b','b','4','4','4','4','d','h','e','h','4','4','4','4','4','0','0','4','4','4','4','c','d','h','f','6','7','0','0','a','b','c','0','0','0','0','0','0','0','0','0','6','7','4','4','4','4','4','4','4','4','4','0','0','d','h','e','h','f'},
                                            {'1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1'},
                                            {'1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','0','0','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1'}};

    Camera cam(0, 0);

    Entity sky(0, 0, skyText);
    sky.setSpriteSrc(0, 0, 1, 1);

    Character mario(250, 400, character);
    mario.updateStatus(0);

    Item test(7, 12, 1, miscText);

    Controller controller(0);
    Map map(&reference[0][0]);

    EventList eventList(&reference[0][0]);
    eventList.addEvent(18, 9, 0);
    eventList.addEvent(24, 9, 0);

    Uint32 frameStart;
    int frameTime;

    bool gameLoop = true;
    SDL_Event event;

    while (gameLoop) {

        frameStart = SDL_GetTicks();
        while (SDL_PollEvent(&event)) {
            if (event.type == SDL_QUIT)
                gameLoop = false;
            controller.pollInputs(event);
        }

        eventList.pollList();

        if (controller.getB())
            mario.setrunning(true);
        else
            mario.setrunning(false);

        if (controller.getL() && controller.getR())
            mario.setvelocityX(mario.getvelocityX() / 1.2);

        else if (controller.getL())
            mario.setvelocityX(mario.getvelocityX() - 1);

        else if (controller.getR())
            mario.setvelocityX(mario.getvelocityX() + 1);

        else if (!controller.getL() && !controller.getR() && !mario.getcanJump())
            mario.setvelocityX(mario.getvelocityX() / 1.05);

        else
            mario.setvelocityX(mario.getvelocityX() / 1.2);

        if (controller.getA())
            mario.jump(-15);

        test.updateEntity(&reference[0][0]);

        mario.updateVelocity();
        mario.move();
        
        mario.pollTiles(false);
        if (mario.collision(&reference[0][0], &eventList, true)) {
            while (mario.collision(&reference[0][0], &eventList, false)) {
                mario.inBounds();
                mario.pollTiles(false);
            }
        }

        window.clear();
        cam.centerX(mario);
        window.render(sky);
        map.loadMap(window, cam, general, &eventList);
        window.render(test, cam);
        window.render(mario, cam);
        window.draw();

        frameTime = SDL_GetTicks() - frameStart;
        if ((1000 / FRAMERATE) > frameTime)
            SDL_Delay((1000 / FRAMERATE) - frameTime);
        
        cam.setframe(cam.getframe() + 1);
    }

    window.close();
    SDL_Quit();
    return 0;
}